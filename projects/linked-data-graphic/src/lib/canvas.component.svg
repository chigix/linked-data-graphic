<svg #mainCanvas ngldPanZoom class="neo4jd3-graph mainCanvas"
    [attr.viewBox]="canvasViewBox.minX
                  + ' ' + canvasViewBox.minY
                  + ' ' + canvasViewBox.width
                  + ' ' + canvasViewBox.height"
    [viewBox]="canvasViewBox"
    (viewBoxChanged)="onViewBoxChanged($event)">
  <g class="relationships">
    <g *ngFor="let rel of d3Graph.relationships" class="relationship"
      [attr.transform]="'translate(' + rel.source.x + ',' + rel.source.y
                        +') rotate(' + rel.rotate + ')'">
      <text ngldBoxSizeListener [listenValue]="rel.pathDrawn.A1.x"
        (boxSize)="rel.textBoxSize=$event"
        class="text" fill="#000000" font-size="8px" pointer-events="none"
        text-anchor="middle"
        [attr.transform]="'translate('
            + rel.textTranslate.x + ',' + rel.textTranslate.y
            + ') rotate('
              + ((rel.rotate > 90 && rel.rotate < 270 )? 180:0)
            + ')'">
        {{ rel.type }}
      </text>
      <path class="outline" fill="#a5abb6" stroke="none"
          [attr.d]="'M ' + rel.pathDrawn.A1.x + ' ' + rel.pathDrawn.A1.y
          + ' L ' + rel.pathDrawn.B1.x + ' ' + rel.pathDrawn.B1.y
          + ' L ' + rel.pathDrawn.C1.x + ' ' + rel.pathDrawn.C1.y
          + ' L ' + rel.pathDrawn.D1.x + ' ' + rel.pathDrawn.D1.y
          + ' Z'
          + ' M ' + rel.pathDrawn.A2.x + ' ' + rel.pathDrawn.A2.y
          + ' L ' + rel.pathDrawn.B2.x + ' ' + rel.pathDrawn.B2.y
          + ' L ' + rel.pathDrawn.C2.x + ' ' + rel.pathDrawn.C2.y
          + ' L ' + rel.pathDrawn.D2.x + ' ' + rel.pathDrawn.D2.y
          + ' L ' + rel.pathDrawn.E2.x + ' ' + rel.pathDrawn.E2.y
          + ' L ' + rel.pathDrawn.F2.x + ' ' + rel.pathDrawn.F2.y
          + ' L ' + rel.pathDrawn.G2.x + ' ' + rel.pathDrawn.G2.y
          + ' Z'"></path>
      <path class="overlay"
          [attr.d]="'M ' + rel.pathDrawn.A3.x + ' ' + rel.pathDrawn.A3.y
          + ' L ' + rel.pathDrawn.B3.x + ' ' + rel.pathDrawn.B3.y
          + ' L ' + rel.pathDrawn.C3.x + ' ' + rel.pathDrawn.C3.y
          + ' L ' + rel.pathDrawn.D3.x + ' ' + rel.pathDrawn.D3.y
          + ' Z'"></path>
    </g>
  </g>
  <g class="nodes">
    <g cdkDrag ngldLongPress ngldPanZoomExclude
      *ngFor="let node of d3Graph.nodes" class="node" [class.selected]="node.selected"
      [class.node-highlighted]="highlightChecker(node)"
      [cdkDragFreeDragPosition]="{ x: node.translate.x, y: node.translate.y }"
      (cdkDragStarted)="onNodeDragStart(node);node.controlledByDragging=true"
      (cdkDragEnded)="simulation.alphaTarget(0)"
      (cdkDragMoved)="onNodeDragging($event, node)"
      (longPressing)="onNodeDragStart(node);node.isLongPressing=true;node.fx=node.x;node.fy=node.y"
      (click)="onNodeClick($event, node)"
      (mouseenter)="activeIndividual.updateActiveIndividual(node)"
      (mouseleave)="activeIndividual.clearActiveIndividual()">
      <circle class="ring" [attr.r]="nodeRadius * 1.16">
        <title> {{ node.labels[0] }} [{{node.id}}] </title>
      </circle>
      <circle class="outline" [attr.r]="nodeRadius" [attr.fill]="node.color.fill" [attr.stroke]="node.color.stroke">
        <title> {{ node.labels[0] }} [{{node.id}}]  </title>
      </circle>
      <text class="text" fill="#ffffff" pointer-events="none" y="4px">
        {{ node.labels.join(' ') }}</text>
      <ng-container *ngIf="node.selected">
        <path *ngFor="let panelRotate of [0,120,240]" class="context-menu-item"
              [attr.transform]="'rotate(' + panelRotate + ')'"
              [attr.d]="'M ' + node.pathDrawn.D1.x + ' ' + node.pathDrawn.D1.y
                    + ' A ' + node.pathDrawn.R1.outer + ' ' + node.pathDrawn.R1.outer + ' 0 0,1 ' + node.pathDrawn.C1.x + ' ' + node.pathDrawn.C1.y
                    + ' L ' + node.pathDrawn.B1.x + ' ' + node.pathDrawn.B1.y
                    + ' A 33 33 0 0,0 ' + node.pathDrawn.A1.x + ' ' + node.pathDrawn.A1.y
                    + ' Z'"></path>
        <g class="icon remove_node context-menu-item" transform="translate(33,-24) scale(0.7)" color="#2A2C34">
          <defs>
            <style>.a{fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round;stroke-width:1.5px;}</style>
          </defs>
          <title>Remove</title>
          <path class="a" d="M8.153,13.664a12.271,12.271,0,0,1-5.936-4.15L1.008,7.96a.75.75,0,0,1,0-.92L2.217,5.486A12.268,12.268,0,0,1,11.9.75h0a12.269,12.269,0,0,1,9.684,4.736L22.792,7.04a.748.748,0,0,1,0,.92L21.584,9.514"></path>
          <path class="a" d="M10.4,10.937A3.749,3.749,0,1,1,15.338,9"></path>
          <circle class="a" cx="17.15" cy="17.25" r="6"></circle>
          <line class="a" x1="14.15" y1="17.25" x2="20.15" y2="17.25"></line>
        </g>
        <g class="icon expand_node context-menu-item" transform="translate(-8,38) scale(0.7)" color="#2A2C34">
          <defs>
            <style>.a{fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round;stroke-width:1.5px;}</style>
          </defs>
          <title>Expand / Collapse</title>
          <line class="a" x1="16.151" y1="7.848" x2="19.411" y2="4.588"></line>
          <line class="a" x1="16.794" y1="12.292" x2="19.079" y2="14.577"></line>
          <line class="a" x1="13.5" y1="14.248" x2="13.5" y2="18.748"></line>
          <line class="a" x1="10.851" y1="13.147" x2="4.59" y2="19.408"></line>
          <line class="a" x1="10.001" y1="9.149" x2="5.61" y2="6.514"></line>
        </g>
        <g class="icon unlock_node context-menu-item" transform="translate(-52,-30) scale(0.7)" color="#2A2C34">
          <defs>
            <style>.a{fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round;stroke-width:1.5px;}</style>
          </defs>
          <title>Unlock</title>
          <path class="a" d="M.75,9.75V6a5.25,5.25,0,0,1,10.5,0V9.75"></path>
          <rect class="a" x="6.75" y="9.75" width="16.5" height="13.5" rx="1.5" ry="1.5"></rect>
          <line class="a" x1="15" y1="15" x2="15" y2="18"></line>
        </g>
      </ng-container>
    </g>
  </g>

  <ng-container *ngIf="debug">
    <path *ngFor="let node of d3Graph.nodes" class="outline" stroke="green" stroke-width="1"
            [attr.d]="'M 0 0 '
            + ' L ' + node.x + ' ' + node.y
            + ' Z'"></path>
  </ng-container>
</svg>
